<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Three.js 3D模型测试</title>
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.158.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.158.0/examples/jsm/"
            }
        }
    </script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #222;
            overflow: hidden;
        }

        #container {
            width: 100vw;
            height: 100vh;
        }

        #info {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            font-family: Arial, sans-serif;
            font-size: 14px;
            z-index: 100;
        }
    </style>
</head>

<body>
    <div id="info">
        <div>Three.js 石油炼化厂3D模型展示</div>
        <div>模型路径: 3d/2_fixed.gltf (修正尺寸后的石油炼化厂场景)</div>
        <div id="loadingStatus">正在加载修正后的石油炼化厂模型...</div>
        <div>请查看控制台输出详细模型信息</div>
        <div style="margin-top: 10px; font-size: 12px;">
            <div>鼠标操作: 模型会自动旋转展示</div>
            <div>包含: 炼油塔、储罐、管道等工业设备</div>
            <div style="margin-top: 5px; color: #ffea00;">
                <div>调试按键: 1-放大 2-缩小 3-重置相机 4-拉远 5-拉近</div>
            </div>
        </div>
    </div>
    <div id="container"></div>

    <script type="module">
        /**
         * @description Three.js 3D模型测试页面 - 使用ES模块
         */
        
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        // 获取容器
        const container = document.getElementById('container');

        // 创建场景
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x222222);
        // 暴露到全局作用域便于调试
        window.scene = scene;

        // 创建相机
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 0, 5);
        // 暴露相机到全局作用域便于调试
        window.camera = camera;

        // 创建渲染器
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        container.appendChild(renderer.domElement);

        // 添加环境光
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambientLight);

        // 添加平行光
        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
        directionalLight.position.set(10, 10, 5);
        scene.add(directionalLight);

        // 添加辅助网格
        const gridHelper = new THREE.GridHelper(10, 10);
        scene.add(gridHelper);

        // 添加坐标轴辅助器
        const axesHelper = new THREE.AxesHelper(5);
        scene.add(axesHelper);

        /**
         * @function fitModelToView
         * @description 自动缩放和居中石油炼化厂模型到视野
         * @param {THREE.Object3D} object 模型对象
         * @param {THREE.PerspectiveCamera} camera 相机对象
         */
        function fitModelToView(object, camera) {
            // 计算包围盒
            const box = new THREE.Box3().setFromObject(object);
            const size = box.getSize(new THREE.Vector3());
            const center = box.getCenter(new THREE.Vector3());

            console.log('=== 石油炼化厂模型调试信息 ===');
            console.log('模型包围盒尺寸:', size);
            console.log('模型包围盒中心:', center);
            console.log('模型最大尺寸:', Math.max(size.x, size.y, size.z));

            // 居中模型
            object.position.sub(center);

            // 针对修正后的模型，尺寸已经合适，只需要微调
            const maxDim = Math.max(size.x, size.y, size.z);
            if (maxDim > 0) {
                // 模型已经在Blender中缩放到合适尺寸，只需要小幅调整以适应视野
                const scale = maxDim > 10 ? 5 / maxDim : 1.0; // 如果还是太大就缩放，否则保持原尺寸
                object.scale.set(scale, scale, scale);
                console.log('应用缩放比例:', scale);
                console.log('原始模型最大尺寸:', maxDim);
                console.log('缩放后模型尺寸:', scale * maxDim);
            }

            // 设置相机位置以俯瞰整个炼化厂（针对修正后的模型尺寸）
            const distance = Math.max(5, maxDim * 1.5); // 根据模型尺寸动态调整距离
            camera.position.set(distance, distance * 0.6, distance);
            camera.lookAt(0, 0, 0);
            
            // 强制更新相机矩阵
            camera.updateProjectionMatrix();

            console.log('相机位置:', camera.position);
            console.log('石油炼化厂模型已居中并缩放');
            console.log('===============================');
        }

        // 加载GLTF模型
        const loader = new GLTFLoader();
        console.log('开始加载修正后的模型: 3d/2_fixed.gltf');
        
        // 更新加载状态
        const loadingStatus = document.getElementById('loadingStatus');
        loadingStatus.style.color = '#ffea00';

        // 尝试加载模型，增加重试机制
        let retryCount = 0;
        const maxRetries = 1; // 减少重试次数，因为使用相对路径应该能直接成功
        
        function loadModel() {
            retryCount++;
            console.log(`第${retryCount}次尝试加载修正后的模型...`);
            console.log('当前页面URL:', window.location.href);
            console.log('模型路径:', './3d/2_fixed.gltf');
            loadingStatus.textContent = `正在加载修正后的石油炼化厂模型... (尝试 ${retryCount}/${maxRetries})`;
            
            loader.load('./3d/2_fixed.gltf',
                function (gltf) {
                    console.log('石油炼化厂模型加载成功!');
                    console.log('模型对象:', gltf.scene);
                    console.log('模型子对象数量:', gltf.scene.children.length);
                    
                    // 遍历模型组件
                    gltf.scene.traverse(function(child) {
                        if (child.isMesh) {
                            console.log('发现模型组件:', child.name, '材质:', child.material?.name);
                        }
                    });
                    
                    loadingStatus.textContent = '修正后的石油炼化厂模型加载成功! 包含' + gltf.scene.children.length + '个主要组件';
                    loadingStatus.style.color = '#00ff00';

                    // 自动适配模型
                    fitModelToView(gltf.scene, camera);

                    // 添加到场景
                    scene.add(gltf.scene);
                    console.log('模型已添加到场景，场景总对象数:', scene.children.length);
                    
                    // 暴露模型到全局作用域便于调试
                    window.oilRefinery = gltf.scene;
                    
                    // 添加键盘控制用于调试
                    window.addEventListener('keydown', function(event) {
                        const model = window.oilRefinery;
                        if (!model) return;
                        
                        switch(event.key) {
                            case '1': // 放大模型
                                model.scale.multiplyScalar(2);
                                console.log('模型放大，当前缩放:', model.scale);
                                break;
                            case '2': // 缩小模型
                                model.scale.multiplyScalar(0.5);
                                console.log('模型缩小，当前缩放:', model.scale);
                                break;
                            case '3': // 重置相机位置
                                camera.position.set(10, 8, 10);
                                camera.lookAt(0, 0, 0);
                                console.log('相机位置重置');
                                break;
                            case '4': // 相机拉远
                                camera.position.multiplyScalar(1.5);
                                console.log('相机拉远，当前位置:', camera.position);
                                break;
                            case '5': // 相机拉近
                                camera.position.multiplyScalar(0.7);
                                console.log('相机拉近，当前位置:', camera.position);
                                break;
                        }
                    });

                    // 开始渲染
                    animate();
                },
                function (progress) {
                    const percent = (progress.loaded / progress.total * 100).toFixed(1);
                    console.log('加载进度:', percent + '%');
                    loadingStatus.textContent = `正在加载模型... ${percent}% (尝试 ${retryCount}/${maxRetries})`;
                },
                function (error) {
                    console.error(`第${retryCount}次加载失败:`, error);
                    console.error('错误详情:', error.message);
                    
                    if (retryCount < maxRetries) {
                        console.log(`将在2秒后重试...`);
                        loadingStatus.textContent = `加载失败，2秒后重试... (尝试 ${retryCount}/${maxRetries})`;
                        loadingStatus.style.color = '#ff4c4c';
                        setTimeout(loadModel, 2000);
                    } else {
                        console.error('所有重试都失败，使用备用立方体');
                        loadingStatus.textContent = '模型加载失败，显示备用立方体';
                        loadingStatus.style.color = '#ff4c4c';
                        
                        // 添加一个简单的立方体作为替代
                        const geometry = new THREE.BoxGeometry(1, 1, 1);
                        const material = new THREE.MeshBasicMaterial({ color: 0x00ff00 });
                        const cube = new THREE.Mesh(geometry, material);
                        scene.add(cube);
                        console.log('已添加测试立方体');
                        animate();
                    }
                }
            );
        }
        
        // 开始加载
        loadModel();

        // 动画循环
        function animate() {
            requestAnimationFrame(animate);

            // 让石油炼化厂模型缓慢旋转展示
            scene.traverse(function(child) {
                if (child.isMesh && child.geometry.type !== 'PlaneGeometry' && !child.name.includes('Grid') && !child.name.includes('Axes')) {
                    child.rotation.y += 0.005; // 更慢的旋转速度，适合观察工业设备细节
                }
            });

            renderer.render(scene, camera);
        }

        // 窗口尺寸变化时自适应
        window.addEventListener('resize', function () {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // 如果没有模型，也要开始渲染（显示网格和坐标轴）
        animate();
    </script>
</body>

</html>